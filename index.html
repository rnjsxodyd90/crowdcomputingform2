<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyze and Categorize an AI Incident</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px 12px 0 0;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 15px;
        }

        .header p {
            font-size: 14px;
            line-height: 1.6;
            opacity: 0.95;
        }

        .incident-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 0;
            padding: 25px;
        }

        .incident-box h2 {
            color: #856404;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .incident-box .incident-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #d4a900;
        }

        .incident-box .meta-item {
            font-size: 14px;
            color: #333;
        }

        .incident-box .meta-item strong {
            color: #856404;
        }

        .incident-box .incident-text {
            color: #333;
            font-size: 15px;
            line-height: 1.7;
            white-space: pre-wrap;
        }

        .form-section {
            background: white;
            padding: 0;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .question {
            padding: 25px 30px;
            border-bottom: 1px solid #eee;
        }

        .question:last-of-type {
            border-bottom: none;
        }

        .question-label {
            font-size: 15px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .question-label .required {
            color: #e53935;
            margin-left: 4px;
        }

        .question-label .multi-hint {
            font-weight: normal;
            color: #666;
            font-size: 13px;
        }

        .text-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: border-color 0.2s;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: #444;
        }

        .option-label:hover {
            background: #f8f9ff;
            border-color: #667eea;
        }

        .option-label input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .option-label.selected {
            background: #f0f3ff;
            border-color: #667eea;
        }

        .submit-section {
            padding: 25px 30px;
            background: #f9f9f9;
            border-radius: 0 0 12px 12px;
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .submit-btn:hover {
            background: #5a6fd6;
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .error-msg {
            color: #e53935;
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }

        .question.error .error-msg {
            display: block;
        }

        .question.error .text-input,
        .question.error .options {
            border-color: #e53935;
        }

        .message-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 60px 40px;
            text-align: center;
        }

        .message-container .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .message-container h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .message-container p {
            color: #666;
            line-height: 1.6;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 4px;
            border-radius: 2px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress-bar .progress {
            background: #667eea;
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- Content loaded dynamically -->
    </div>

    <script src="incidents.js"></script>
    <script>
        const STORAGE_KEY = 'ai_incident_survey_answered';
        const app = document.getElementById('app');

        // Get incident ID from URL parameter
        function getIncidentIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('incident');
            return id ? parseInt(id) : null;
        }

        // Get next available incident ID (round-robin)
        function getNextIncidentId() {
            const counter = parseInt(localStorage.getItem('incident_counter') || '0');
            const incidentId = (counter % incidents.length) + 1;
            localStorage.setItem('incident_counter', (counter + 1).toString());
            return incidentId;
        }

        // Check if user has already answered
        function hasAnswered() {
            return localStorage.getItem(STORAGE_KEY) !== null;
        }

        // Save answers
        function saveAnswers(incidentId, answers) {
            const data = {
                incidentId: incidentId,
                answers: answers,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // Get answered data
        function getAnsweredData() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : null;
        }

        // Find incident by ID
        function findIncident(id) {
            return incidents.find(i => i.id === id);
        }

        // Render the form
        function renderForm(incident) {
            let questionsHtml = questions.map((q, idx) => {
                let inputHtml = '';

                if (q.type === 'text') {
                    // Pre-fill incident number for question 1
                    const prefillValue = q.id === 1 ? incident.id : '';
                    const readonly = q.id === 1 ? 'readonly' : '';
                    inputHtml = `<input type="text" class="text-input" name="q${q.id}" value="${prefillValue}" ${readonly}>`;
                } else if (q.type === 'radio') {
                    inputHtml = `<div class="options">
                        ${q.options.map((opt, i) => `
                            <label class="option-label">
                                <input type="radio" name="q${q.id}" value="${opt}">
                                <span>${opt}</span>
                            </label>
                        `).join('')}
                    </div>`;
                } else if (q.type === 'checkbox') {
                    inputHtml = `<div class="options">
                        ${q.options.map((opt, i) => `
                            <label class="option-label">
                                <input type="checkbox" name="q${q.id}" value="${opt}">
                                <span>${opt}</span>
                            </label>
                        `).join('')}
                    </div>`;
                }

                const multiHint = q.type === 'checkbox' ? '<span class="multi-hint"> (Multiple options allowed)</span>' : '';

                return `
                    <div class="question" data-question="${q.id}">
                        <div class="question-label">
                            ${idx + 1}. ${q.question}${multiHint}
                            ${q.required ? '<span class="required">*</span>' : ''}
                        </div>
                        ${inputHtml}
                        <div class="error-msg">This question is required</div>
                    </div>
                `;
            }).join('');

            app.innerHTML = `
                <div class="header">
                    <h1>Analyze and Categorize an AI Incident</h1>
                    <p>Welcome to the AI incidents study. Thank you for taking the time to contribute!</p>
                    <p style="margin-top: 10px;">Please read the incident description carefully and answer the questions based only on the information provided in the report. If the report does not contain enough information to answer a question confidently, select "Cannot be determined" rather than guessing.</p>
                    <div class="progress-bar"><div class="progress" id="progress"></div></div>
                </div>

                <div class="incident-box">
                    <h2>Incident Report #${incident.id}</h2>
                    <div class="incident-meta">
                        <div class="meta-item"><strong>Impact:</strong> ${incident.impact}</div>
                        <div class="meta-item"><strong>Date:</strong> ${incident.date}</div>
                        <div class="meta-item"><strong>Classification:</strong> ${incident.classification.join('; ')}</div>
                    </div>
                    <div class="incident-text">${incident.description}</div>
                </div>

                <div class="form-section">
                    ${questionsHtml}
                    <div class="submit-section">
                        <button class="submit-btn" id="submitBtn">Submit Answers</button>
                    </div>
                </div>
            `;

            // Add event listeners
            setupFormListeners(incident);
        }

        // Setup form event listeners
        function setupFormListeners(incident) {
            const submitBtn = document.getElementById('submitBtn');
            const progressBar = document.getElementById('progress');

            // Update progress and styling on input change
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', () => {
                    updateProgress();

                    // Update selected styling for options
                    if (input.type === 'radio' || input.type === 'checkbox') {
                        const optionLabels = input.closest('.options').querySelectorAll('.option-label');
                        optionLabels.forEach(label => {
                            const inp = label.querySelector('input');
                            if (inp.type === 'radio') {
                                label.classList.toggle('selected', inp.checked);
                            } else {
                                label.classList.toggle('selected', inp.checked);
                            }
                        });
                    }
                });
            });

            // Submit handler
            submitBtn.addEventListener('click', async () => {
                if (validateForm()) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';

                    const answers = collectAnswers();

                    try {
                        // Send to Google Sheets
                        await fetch('https://script.google.com/macros/s/AKfycbx_1yAT1702ToCvzKVl-ATYsyKUGdH2AH-LA-MKsSQ8c4zJqMW6q-Ab3gv5i08QUQrE/exec', {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(answers)
                        });

                        saveAnswers(incident.id, answers);

                        // Redirect to Prolific completion URL
                        window.location.href = 'https://app.prolific.com/submissions/complete?cc=C1P4ALOM';
                    } catch (error) {
                        console.error('Error submitting:', error);
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Answers';
                        alert('Error submitting. Please try again.');
                    }
                }
            });

            function updateProgress() {
                const total = questions.length;
                let answered = 0;

                questions.forEach(q => {
                    if (q.type === 'text') {
                        const input = document.querySelector(`input[name="q${q.id}"]`);
                        if (input && input.value.trim()) answered++;
                    } else if (q.type === 'radio') {
                        const checked = document.querySelector(`input[name="q${q.id}"]:checked`);
                        if (checked) answered++;
                    } else if (q.type === 'checkbox') {
                        const checked = document.querySelectorAll(`input[name="q${q.id}"]:checked`);
                        if (checked.length > 0) answered++;
                    }
                });

                const percent = (answered / total) * 100;
                progressBar.style.width = percent + '%';
            }

            function validateForm() {
                let valid = true;

                questions.forEach(q => {
                    if (!q.required) return;

                    const questionDiv = document.querySelector(`.question[data-question="${q.id}"]`);
                    let hasAnswer = false;

                    if (q.type === 'text') {
                        const input = document.querySelector(`input[name="q${q.id}"]`);
                        hasAnswer = input && input.value.trim() !== '';
                    } else if (q.type === 'radio') {
                        hasAnswer = document.querySelector(`input[name="q${q.id}"]:checked`) !== null;
                    } else if (q.type === 'checkbox') {
                        hasAnswer = document.querySelectorAll(`input[name="q${q.id}"]:checked`).length > 0;
                    }

                    if (!hasAnswer) {
                        questionDiv.classList.add('error');
                        valid = false;
                    } else {
                        questionDiv.classList.remove('error');
                    }
                });

                if (!valid) {
                    const firstError = document.querySelector('.question.error');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }

                return valid;
            }

            function collectAnswers() {
                const answers = {};

                // Include Prolific parameters
                const prolific = getProlificParams();
                answers.visitorId = prolific.visitorId;
                answers.studyId = prolific.studyId;
                answers.sessionId = prolific.sessionId;

                questions.forEach(q => {
                    if (q.type === 'text') {
                        const input = document.querySelector(`input[name="q${q.id}"]`);
                        answers[`q${q.id}`] = input ? input.value.trim() : '';
                    } else if (q.type === 'radio') {
                        const checked = document.querySelector(`input[name="q${q.id}"]:checked`);
                        answers[`q${q.id}`] = checked ? checked.value : '';
                    } else if (q.type === 'checkbox') {
                        const checked = document.querySelectorAll(`input[name="q${q.id}"]:checked`);
                        answers[`q${q.id}`] = Array.from(checked).map(c => c.value);
                    }
                });

                return answers;
            }

            // Initial progress update
            updateProgress();
        }

        // Render thank you message
        function renderThankYou() {
            app.innerHTML = `
                <div class="message-container">
                    <div class="icon">&#10004;</div>
                    <h2>Thank You!</h2>
                    <p>Your response has been recorded successfully.</p>
                    <p style="margin-top: 15px; color: #888;">Thank you for contributing to improving the understanding of real-world AI incidents.</p>
                </div>
            `;
        }

        // Render already answered message
        function renderAlreadyAnswered() {
            const data = getAnsweredData();

            app.innerHTML = `
                <div class="message-container">
                    <div class="icon">&#128077;</div>
                    <h2>You've Already Participated</h2>
                    <p>Thank you for your previous response!</p>
                    <p style="margin-top: 15px; color: #888;">
                        You analyzed Incident #${data.incidentId} on ${new Date(data.timestamp).toLocaleDateString()}
                    </p>
                </div>
            `;
        }

        // Render error message
        function renderError(message) {
            app.innerHTML = `
                <div class="message-container">
                    <div class="icon">&#9888;</div>
                    <h2>Oops!</h2>
                    <p>${message}</p>
                </div>
            `;
        }

        // Render loading message
        function renderLoading() {
            app.innerHTML = `
                <div class="message-container">
                    <div class="icon">&#8987;</div>
                    <h2>Loading...</h2>
                    <p>Please wait while we prepare your survey.</p>
                </div>
            `;
        }

        // Render all incidents claimed message
        function renderAllClaimed() {
            app.innerHTML = `
                <div class="message-container">
                    <div class="icon">&#128275;</div>
                    <h2>Survey Complete</h2>
                    <p>All incidents have been assigned to participants.</p>
                    <p style="margin-top: 15px; color: #888;">Thank you for your interest!</p>
                </div>
            `;
        }

        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx_1yAT1702ToCvzKVl-ATYsyKUGdH2AH-LA-MKsSQ8c4zJqMW6q-Ab3gv5i08QUQrE/exec';
        const TOKEN_KEY = 'ai_incident_user_token';

        // Get Prolific parameters from URL
        function getProlificParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                visitorId: params.get('PROLIFIC_PID') || '',
                studyId: params.get('STUDY_ID') || '',
                sessionId: params.get('SESSION_ID') || ''
            };
        }

        // Get or claim an incident from the server
        async function getAssignedIncident() {
            const existingToken = localStorage.getItem(TOKEN_KEY);
            const url = existingToken
                ? `${SCRIPT_URL}?token=${encodeURIComponent(existingToken)}`
                : SCRIPT_URL;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.incidentId === null) {
                    return { success: false, allClaimed: true };
                }

                // Save token if new one was issued
                if (data.token) {
                    localStorage.setItem(TOKEN_KEY, data.token);
                }

                return { success: true, incidentId: data.incidentId };
            } catch (error) {
                console.error('Error fetching incident:', error);
                return { success: false, error: true };
            }
        }

        // Initialize
        async function init() {
            if (hasAnswered()) {
                renderAlreadyAnswered();
                return;
            }

            renderLoading();

            const result = await getAssignedIncident();

            if (!result.success) {
                if (result.allClaimed) {
                    renderAllClaimed();
                } else {
                    renderError('Unable to load survey. Please try again later.');
                }
                return;
            }

            const incident = findIncident(result.incidentId);

            if (!incident) {
                renderError('Incident not found. Please contact the administrator.');
                return;
            }

            // Update URL to show incident number
            const newUrl = `${window.location.pathname}?incident=${result.incidentId}`;
            window.history.replaceState({}, '', newUrl);

            renderForm(incident);
        }

        init();
    </script>
</body>
</html>
